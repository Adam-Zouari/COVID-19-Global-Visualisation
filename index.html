<!DOCTYPE html>

<head>
    <title>COVID-19 Visualizer</title>
    <!-- Meta -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- CSS / Favicon -->
    <link href="styles.css" rel="stylesheet" />
    
    <!-- JavaScript -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="dataService.js" defer></script>
    <script src="globe.js" defer></script>
</head>

<body>
    <div id="particles"></div>
    <div id="globe" class="centered-globe"></div>

    <div id="header">
        <div id="search">
            <img src="assets/icons/search.svg" onclick="openSearch()">
        </div>
        
        <!-- Replace SVG use elements with direct image references -->
        <div class="dataset-buttons">
            <button id="epidemBtn" class="dataset-btn active" onclick="changeDataset('epidem')" title="Epidemiology">
                <img src="assets/icons/virus.svg" class="dataset-icon" alt="Epidemiology">
            </button>
            <button id="hospBtn" class="dataset-btn" onclick="changeDataset('hospitalizations')" title="Hospitalizations">
                <img src="assets/icons/hospital.svg" class="dataset-icon" alt="Hospitalizations">
            </button>
            <button id="vaccBtn" class="dataset-btn" onclick="changeDataset('vaccinations')" title="Vaccinations">
                <img src="assets/icons/syringe.svg" class="dataset-icon" alt="Vaccinations">
            </button>
        </div>
        
        <h1>COVID-19</h1>
    </div>
    
    <!-- Search Modal Overlay -->
    <div id="searchModal" class="search-modal">
        <div class="search-container">
            <div class="search-header">
                <h3>Search Countries</h3>
                <button class="close-search" onclick="closeSearch()">Ã—</button>
            </div>
            <input type="text" id="countrySearchInput" placeholder="Type country name..." autocomplete="off">
            <div id="countryList" class="country-list"></div>
        </div>
    </div>
    
    <div id="loader"></div>
    
    <!-- Country Info Panel -->
    <div id="countryInfo">
        <h3 id="countryName">Select a country</h3>
        <div id="countryStats"></div>
    </div>
    
    <!-- Controls Panel -->
    <div class="control-panel">
        <!-- Removed the dataset buttons -->
        <div class="dataset-indicator">
            <span id="currentDataset">Epidemiology</span>
        </div>
        
        <div class="data-selector-container">
            <label for="dataSelector">Data Type: </label>
            <select id="dataSelector"></select>
        </div>
        
        <div class="date-controls">
            <button id="prevDateBtn">&lt;</button>
            <span id="currentDate">Loading...</span>
            <button id="nextDateBtn">&gt;</button>
        </div>
        
        <input type="range" id="dateSlider" min="0" max="100" value="0">
        
        <button id="resetBtn" class="control-btn">Reset View</button>
    </div>
    
    <div id="dataStatus">Loading data...</div>
    
    <!-- Error display for data loading issues -->
    <div id="errorDisplay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; color: white; padding: 20px; flex-direction: column; align-items: center; justify-content: center;">
        <h2>Data Loading Error</h2>
        <div id="errorMessage"></div>
        <button id="errorClose" style="margin-top: 20px; padding: 8px 16px;">Close</button>
    </div>

    <script>
        // Hide loader when the globe is initialized
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const loader = document.getElementById('loader');
                if (loader) {
                    loader.style.display = 'none';
                }
            }, 2000); // Give some time for data to load
            
            // Center the globe visualization properly
            document.addEventListener('GlobeVisualizationInitialized', function() {
                const globeInstance = window.globeInstance;
                if (globeInstance) {
                    // Adjust the globe position to be centered and higher
                    globeInstance.globeGroup.attr('transform', 
                        `translate(${window.innerWidth / 2}, ${window.innerHeight / 2 - 50})`); // Move up by 50px
                    
                    // Update the backdrop position
                    d3.select('.globe-backdrop')
                        .attr('cx', window.innerWidth / 2)
                        .attr('cy', window.innerHeight / 2 - 50); // Move up by 50px
                        
                    // Force a redraw of the globe
                    globeInstance.globeGroup.selectAll('path')
                        .attr('d', globeInstance.path);
                    
                    // Initialize with the default dataset background without animation
                    document.body.style.background = 'radial-gradient(#4a0000, #000)';
                    
                    // Initialize reset button color to match default dataset (epidem)
                    globeInstance.updateResetButtonColor('epidem');
                }
            });
            
            // Initialize particles.js with configuration - fewer particles and no stars behind globe
            particlesJS('particles', {
                "particles": {
                    "number": {
                        "value": 70,
                        "density": {
                            "enable": true,
                            "value_area": 800
                        }
                    },
                    "color": {
                        "value": "#ffffff"
                    },
                    "shape": {
                        "type": "circle",
                        "stroke": {
                            "width": 0,
                            "color": "#000000"
                        }
                    },
                    "opacity": {
                        "value": 0.3,
                        "random": true,
                        "anim": {
                            "enable": true,
                            "speed": 0.5,
                            "opacity_min": 0.1,
                            "sync": false
                        }
                    },
                    "size": {
                        "value": 2,
                        "random": true,
                        "anim": {
                            "enable": true,
                            "speed": 2,
                            "size_min": 0.1,
                            "sync": false
                        }
                    },
                    "line_linked": {
                        "enable": false
                    },
                    "move": {
                        "enable": true,
                        "speed": 1.2,
                        "direction": "none",
                        "random": true,
                        "straight": false,
                        "out_mode": "out",
                        "bounce": false,
                        "attract": {
                            "enable": true,
                            "rotateX": 600,
                            "rotateY": 1200
                        }
                    }
                },
                "interactivity": {
                    "detect_on": "canvas",
                    "events": {
                        "onhover": {
                            "enable": true,
                            "mode": "bubble"
                        },
                        "onclick": {
                            "enable": false
                        },
                        "resize": true
                    },
                    "modes": {
                        "bubble": {
                            "distance": 150,
                            "size": 3,
                            "duration": 2,
                            "opacity": 0.5,
                            "speed": 3
                        }
                    }
                },
                "retina_detect": true
            });
        });
        
        // Replace toggleDataset function with direct dataset change function
        function changeDataset(datasetKey) {
            if (!window.globeInstance) return;
            
            // Update the dataset name display
            const datasetDisplayNames = {
                'epidem': 'Epidemiology',
                'hospitalizations': 'Hospitalizations',
                'vaccinations': 'Vaccinations'
            };
            
            // Update the current dataset display text
            const currentDatasetEl = document.getElementById('currentDataset');
            if (currentDatasetEl) {
                currentDatasetEl.textContent = datasetDisplayNames[datasetKey] || datasetKey;
            }
            
            // Change dataset in the globe visualization
            window.globeInstance.changeDataset(datasetKey);
            
            // Update button active states
            document.querySelectorAll('.dataset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Activate the selected button
            const buttonMap = {
                'epidem': 'epidemBtn',
                'hospitalizations': 'hospBtn',
                'vaccinations': 'vaccBtn'
            };
            
            const activeBtn = document.getElementById(buttonMap[datasetKey]);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }
        
        // Search functionality
        function openSearch() {
            document.getElementById('searchModal').classList.add('active');
            document.getElementById('countrySearchInput').value = ''; // Clear previous search
            document.getElementById('countrySearchInput').focus();
            
            // Always populate the country list when opening search
            populateCountryList();
        }
        
        function closeSearch() {
            document.getElementById('searchModal').classList.remove('active');
        }
        
        function populateCountryList() {
            if (!window.globeInstance) return;
            
            const countryList = document.getElementById('countryList');
            countryList.innerHTML = '';
            
            // Get all countries from the dataService
            const countries = window.globeInstance.dataService.getAllCountries();
            
            if (countries.length === 0) {
                // If no countries are found, show a message
                countryList.innerHTML = '<div class="no-countries">Loading countries... Please wait.</div>';
                
                // Try again in a moment - data might still be loading
                setTimeout(() => {
                    const retryCountries = window.globeInstance.dataService.getAllCountries();
                    if (retryCountries.length > 0) {
                        populateCountryList();
                    }
                }, 1000);
                return;
            }
            
            // Sort countries alphabetically by name
            countries.sort((a, b) => a.countryName.localeCompare(b.countryName));
            
            // Create elements for each country
            countries.forEach(country => {
                const countryItem = document.createElement('div');
                countryItem.className = 'country-item';
                countryItem.innerHTML = `
                    <img class="country-flag" src="https://flagcdn.com/${country.countryCode.toLowerCase()}.svg" 
                         onerror="this.src='https://via.placeholder.com/24x16/ddd/aaa?text=?'">
                    <span>${country.countryName}</span>
                `;
                
                countryItem.addEventListener('click', () => {
                    window.globeInstance.goToCountry(country.countryCode);
                    closeSearch();
                });
                
                countryList.appendChild(countryItem);
            });
            
            // Set up live filtering
            document.getElementById('countrySearchInput').addEventListener('input', filterCountries);
        }
        
        function filterCountries() {
            const input = document.getElementById('countrySearchInput');
            const filter = input.value.toUpperCase();
            const countryList = document.getElementById('countryList');
            const countryItems = countryList.getElementsByClassName('country-item');
            
            for (let i = 0; i < countryItems.length; i++) {
                const span = countryItems[i].getElementsByTagName('span')[0];
                const txtValue = span.textContent || span.innerText;
                
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    countryItems[i].style.display = '';
                } else {
                    countryItems[i].style.display = 'none';
                }
            }
        }
    </script>
</body>

</html>
